<!-- b8e66d5f-51be-4793-a29d-d843c2c6145b 3cf0efb7-18ef-4ef6-ae91-706a28c56a03 -->
# 385 Safety Plan RAG – Implementation Plan

## Deliverables

- DOCX + auto-generated PDF for CSP and AHA Book
- “Why this section?” provenance view with page labels and quote anchors
- Cross-reference table (AHAs ↔ CSP sections)

## Phase 1 — Retrieval Accuracy & Provenance

- Reingest EM 385 with heading-aware chunking and rich metadata
- Add `section_path`, `headers`, `page_number` (PDF label and index), `quote_anchor`, `title` to metadata
- Preserve stable `chunk_id` and deterministic IDs
- Files: `pdf_loader/pdf_loader.py`, `rag_agent.py` (`_process_and_insert_chunks`), `utils.py` (metadata helpers)
- Hybrid retrieval + reranking
- Keep vector + keyword fallback; add cross-encoder reranker for top-20 → top-5
- Files: `utils.py` (new `rerank_results`), `rag_agent.py` (`retrieve`)
- Strict citation policy
- Update agent system prompt to require citations per paragraph with `§sec, page N, “quote anchor”`
- Verify each citation resolves to stored chunk text; fall back to retry with targeted terms
- Files: `rag_agent.py` (prompt, `retrieve`, verification integration), `verify.py`
- Caching hot sections
- LRU cache for retrieval by (query, filters); warm common tokens (Fall Protection, Excavation)
- Files: `utils.py` (cache), `rag_agent.py` (`retrieve`)

## Phase 2 — Activity & Hazard Detection

- Activity detection
- Rule-first keyword mapper + optional zero-shot classifier for ambiguous specs
- Files: `generators/activity_detect.py`, `mappings/activities.json`
- Hazard and control inference
- Map activities → hazards → EM 385 sections; generate retrieval queries per hazard
- Files: `generators/hazard_map.py`, `mappings/hazards.json`

## Phase 3 — AHA Generation

- AHA data model and generator
- Pydantic models (sequence steps, hazards, controls, PPE, permits, training, citations)
- Pull citations from retrieval with page + quote anchors
- Files: `models/aha.py`, `generators/aha.py`
- AHA Book compiler + crosswalk
- Build consolidated artifact with index (AHA ↔ CSP sections)
- Files: `generators/aha_book.py`

## Phase 4 — CSP Generation

- CSP template + section synthesis
- Fixed template of sections; each section populated from detected activities and rules-backed citations
- Files: `models/csp.py`, `generators/csp.py`, `templates/csp_template.docx`
- Provenance in-text
- Inline footnotes or endnotes citing `§sec, page N, “anchor”`

## Phase 5 — Export (DOCX + PDF)

- DOCX writers
- Use `python-docx` with styles, headers/footers, auto TOC for AHA Book and CSP
- Files: `export/docx_writer.py`, `templates/styles.json`
- PDF generation
- Preferred: HTML render + `weasyprint` to PDF for consistent server-side output
- Fallback: DOCX → PDF via `docx2pdf` where available (desktop) or user download
- Files: `export/pdf_writer.py`, `templates/html/*`

## Phase 6 — UI/UX (Streamlit)

- Spec input → analysis → activities preview → generate AHAs → review/edit → approve → generate CSP
- “Why this section?” collapsible details with exact source chunks and quote anchors
- Export buttons (DOCX, PDF, ZIP)
- Files: `streamlit_app.py`, new views in `ui/components/*`

## Phase 7 — Performance & Scale

- Async concurrent generation for AHAs; shared retrieval cache across tasks
- Batch queries to Chroma; limit embeddings model calls
- Optional background job queue for large specs (if needed later)

## Phase 8 — Quality Control & Tests

- Unit tests: retrieval, rerank, verification, chunking, activity mapping, AHA/CSP generation
- Integration tests: end-to-end spec → AHAs → CSP with golden files
- Coverage for citations resolving to real chunks (page + anchor)
- Files: `tests/*`

## Files to Add/Change (high impact)

- Update: `pdf_loader/pdf_loader.py`, `rag_agent.py`, `utils.py`, `streamlit_app.py`, `verify.py`
- New: `models/aha.py`, `models/csp.py`, `generators/activity_detect.py`, `generators/hazard_map.py`, `generators/aha.py`, `generators/aha_book.py`, `generators/csp.py`, `export/docx_writer.py`, `export/pdf_writer.py`, `mappings/activities.json`, `mappings/hazards.json`, `templates/csp_template.docx`, `templates/html/*`, tests under `tests/`

## Milestone Sequence

1) Retrieval accuracy & provenance (Phase 1)
2) Activity detection + AHA generation (Phases 2–3)
3) CSP generation + exports (Phases 4–5)
4) UI/UX workflow (Phase 6)
5) Performance & QA hardening (Phases 7–8)

### To-dos

- [ ] Implement heading-aware EM385 chunking + rich metadata in pdf_loader and utils
- [ ] Add hybrid retrieval reranker and integrate in agent retrieve
- [ ] Enforce per-paragraph citations and verify anchors resolve to chunks
- [ ] Add LRU caching and warm common sections for speed
- [ ] Build activity detection from specs (rules + optional zero-shot)
- [ ] Map activities to hazards and EM385 sections
- [ ] Create AHA models and generator with citations
- [ ] Compile AHA Book with crosswalk index
- [ ] Create CSP models and generator using template
- [ ] Implement DOCX writers for AHA Book and CSP
- [ ] Implement HTML render + WeasyPrint PDF (fallback docx2pdf)
- [ ] Extend Streamlit UI for analyze→generate→review→export
- [ ] Make AHA generation concurrent; share retrieval cache
- [ ] Add unit/integration tests incl. citation resolution checks